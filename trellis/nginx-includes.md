---
ID: 6153
post_title: Nginx Includes
author: Ben Word
post_date: 2015-09-03 18:05:06
post_excerpt: ""
layout: doc
permalink: >
  https://roots.io/trellis/docs/nginx-includes/
published: true
---
The Nginx site conf generated by Trellis is designed to work with a wide range of WordPress installations, but your sites may require customization. For example, perhaps you use custom `rewrite`s to redirect legacy URLs, or maybe you would like to proxy some requests to another server. Trellis provides hooks in Nginx conf files, enabling you to include files or inject snippets.

## Files
You may put your Nginx customizations in Ansible/Jinja2 templates, making full use of variables and logic. Store your template files in a new `nginx-includes` directory in the root of your Trellis project. If you prefer to name this directory `some-other-name`, you may define `nginx_includes_templates_path: some-other-name` in your `group_vars/all/main.yml`.

Trellis will recurse `nginx-includes` and template any files ending in `*.conf.j2` to the `/etc/nginx/includes.d/` directory on the remote, preserving the subdirectory structure. If you want to edit, add to, or delete your Nginx include files, edit them on the local machine and re-run the playbook. Tip: Append `--tags nginx-includes` to your command to run only the relevant portion of the playbook.

### Default
By default in Trellis, a WordPress site's Nginx conf will include any `nginx-includes` files found in a subdirectory named after the site. To illustrate, suppose you have two sites managed by Trellis, defined in `wordpress_sites` as follows:

```
wordpress_sites:
  site1:
    ...
  site2:
    ...
```

You could organize your `nginx-includes` templates in corresponding subdirectories:

```
nginx-includes/
  site1/
    rewrites.conf.j2
    proxy.conf.j2
  site2/
    rewrites.conf.j2
```

The above directory structure would be templated to the remote server as follows:

```
/
  etc/
    nginx/
      includes.d/
        site1/
          rewrites.conf
          proxy.conf
        site2/
          rewrites.conf
```

To explicitly walk through the example, consider just the `site1` site key in the `wordpress_sites` list. The corresponding `nginx-includes/site1/` directory contains two confs which are templated to the remote's `/etc/nginx/includes.d/site1/`. The primary Nginx conf for `site1` will have a statement `include includes.d/site1/*.conf;`, thus including `rewrites.conf` and `proxy.conf`.

This `include` directive is located inside the primary `server` block, just before the primary `location` block. Explore the "Hooks" section below for more explanation and options, particularly if this default does not satisfy your needs.

Note that this default `include` directive per site will not recurse subdirectories within `includes.d/site1` so if you place templates in `nginx-includes/site1/somedir/*.conf.j2`, they will be templated to the remote's `includes.d/site1/somedir/*.conf` but will not be included by default. See the "Hooks" section below for how you could include such confs.

### File cleanup
By default, Trellis will remove from the remote's `includes.d` directory any `*.conf` file that lacks a corresponding template in your local machine's `nginx-includes`. If you prefer to leave all conf files on the remote, you may disable this file cleanup by defining `nginx_includes_d_cleanup: false` in `group_vars/all/main.yml`.

### Deprecated templates directory
The original implementation of Trellis Nginx includes required template files to be stored in `roles/wordpress-setup/templates/includes.d`. That directory is now deprecated and will no longer function beginning with Trellis 1.0. Please move your templates to a directory named `nginx-includes` in the root of this project. It is preferable to store user-created templates separate from Trellis core files.

## Hooks
Trellis provides Nginx hooks enabling you to specify snippets or includes at various locations in the Nginx conf files, as in the diagram below.

```
# nginx.conf
...

http {
  # HOOK: nginx_http
  ...

  # --- begin site-specific wordpress-site.conf ---

  # HOOK: nginx_server_before

  server {
    ...

    # HOOK: nginx_location_before
    # default: include includes.d/{{ item.key }}/*.conf;

    location / {
      # HOOK: nginx_location
      ...
    }

    location ~ \.php$ {
      # HOOK: nginx_location_php
      ...
    }
  }
}
```

A few notes about the above diagram:

* The file includes mentioned in the "Default" section above use the `nginx_location_before` hook, inserting `include includes.d/{{ item.key }}/*.conf;`.
* The `nginx_http` hook is processed in the `nginx` role. Append `--tags nginx` to your command to run only this portion of the playbook.
* The other hooks are processed in the `wordpress-setup` role. Append `--tags nginx-includes` to your command to run tasks associated with all hooks.

### Global hooks
All hooks default to empty except `nginx_location_before`.

```
nginx_http: ''
nginx_server_before: ''
nginx_location_before: include includes.d/{{ item.key }}/*.conf;
nginx_location: ''
nginx_location_php: ''
```

You may define any of these hooks in `group_vars/all/main.yml` if applicable to all environments, or in `group_vars/<environment>/main.yml` if environment-specific. Note that if you define `nginx_location_before`, you will be overriding the default file include mentioned above. If you would like to use this hook but still preserve the default, see the "Mixed example" below.

### Site-specific hooks
Most hooks can also accept site-specific values, i.e., those that fall within the hook diagram's section labeled `# --- begin site-specific wordpress-site.conf ---`. A site-specific hook definition will take precedence over a global definition. Define site-specific hooks within the `wordpress_sites` list.

```
wordpress_sites:
  site1:
    ...
    nginx_server_before: some nginx directive
    nginx_location_before: some nginx directive
    nginx_location: some nginx directive
    nginx_location_php: some nginx directive
```

### Hook format examples
You may define the Nginx hook variables like any other Ansible variable, which leaves you many format options. The simplest form is a single line string, perhaps with a variable.

```
nginx_server_before: some nginx directive
nginx_location_before: include includes.d/{{ item.key }}/*.conf;
```

#### Multiline example
Ansible variables can use `|` to indicate that a multiline value follows on lines below.

```
nginx_http: |
  server_names_hash_bucket_size 128;
  server_names_hash_max_size 512;
nginx_server_before: some nginx directive
```

#### Custom include example
Suppose you would like a specific site conf's `nginx_location_php` hook to insert an `include` statement for a conf file built from the template `nginx-includes/snippets/my-snippet.conf.j2`. Remember that Trellis templates all the `nginx-includes` files and subdirectories to the remote's `/etc/nginx/includes.d`, so the following hook definition works.

```
wordpress_sites:
  site2:
    ...
    nginx_location_php: include includes.d/snippets/my-snippet.conf;
```

#### Template lookup example
Now suppose for some reason you do not want to use an `include` directive for the `my-snippet.conf` above, preferring to have the contents of `my-snippet.conf.j2` inserted right into the primary site conf at the location of the `nginx_location_php` hook. You could use a template lookup as follows:

```
wordpress_sites:
  site2:
    ...
    nginx_location_php: "{{ lookup('template', 'nginx-includes/snippets/my-snippet.conf.j2') }}"
```

Note that Ansible's template lookup feature is performed on the local machine, so the example above must use the template's local path within `nginx-includes`.

#### Mixed example
Note that if you define the `nginx_location_before` hook, your value replaces the default `include includes.d/{{ item.key }}/*.conf;`. This replacement is convenient if you want to override that default. However, suppose you would like to retain and augment the default. You could use a multiline definition as follows:

```
wordpress_sites:
  site1:
    ...
    nginx_server_before: ''
    nginx_location_before: |
      # multiline mix and match of above examples
      {{ lookup('template', 'nginx-includes/snippets/my-snippet.conf.j2') }}
      include includes.d/site1/*.conf;
    nginx_location_php: some directive
```

To illustrate another point, the above example's `nginx_server_before: ''` sets that hook back to empty, perhaps to override a global value you assigned the hook. It is important to use empty single quotes in this context so that Ansible interprets the value as an empty string. Ansible will interpret empty double quotes as `NoneType` which can cause templating errors.

Trellis Nginx includes were originally made possible thanks to @chriszarate in [#242](https://github.com/roots/trellis/pull/242).
